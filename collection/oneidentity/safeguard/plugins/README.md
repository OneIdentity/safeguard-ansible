# Collections Plugins Directory

The Safeguard resource for Ansible collection includes a lookup plugin that allows Ansible to pull credentials from Safeguard for Privileged Passwords (SPP). The purpose of a lookup plugin is to access data from third party source such as Safeguard for Privileged Passwords. A lookup plugin can be anywhere you can use templating in Ansible such as in playbooks, variable files, inventory files, etc. The following includes some examples of how to use the Safeguard credentials lookup plugin.

## Safeguard Credentials lookup plugin

The Safeguard Credentials lookup plugin allows Ansible to pull a credential from SPP through the Application to Application (A2A) API. This requires that an A2A registration has been created in SPP. For more information about how to create an A2A registration, please see the Safeguard for Privileged Passwords Administration Guide for your version of SPP (https://support.oneidentity.com/technical-documents).

### Installation
{TBD}

### Configuration

When an A2A registration is created in SPP, there are several pieces of information that must be used by the third party appliation in order to access and retrieve the associated credential. This information includes:

* A2A api key that identifies the specific credential
* A client authentication certificate file (PEM format)
* A client authentication private key (PEM format)
* The TLS public certificate used to verify the SPP appliance

Given this information from an A2A registration, the Safeguard credential lookup plugin will be able to retrieve the associated credential from SPP.

The Safeguard Credential lookup plugin takes 2 parameters in addition to the plugin name.

```yaml
vars:
  spp_a2a_apikey: +IWSU/0msm98hUUUen5xOnYZZytVN2o9hLFxVr9S80Q=
  a2aconnectioninfo:
      spp_appliance: 192.168.1.234
      spp_certificate_file: /etc/ansible/spp/a2ausercert.pem
      spp_certificate_key: /etc/ansible/spp/a2ausercert.key
      spp_tls_cert: /etc/ansible/spp/spptlscert.pem
  spp_credential: "{{lookup('oneidentity.safeguard.safguardcredentials', spp_a2a_apikey, a2aconnection=a2aconnectioninfo)}}"
```
Parameters:
* spp_a2a_apikey - The api key is generated by SPP and it identifies a specific credential that has been made available through the A2A registration, to be retrieved by a third party application.
* a2aconnectioninfo - A dictionary of information needed to connect to the SPP appliance.
    * spp_appliance - The IP address or host name of the SPP appliance.
    * spp_certificate_file - The full path to the user authentication certificate (PEM format).
    * spp_certificate_key - The full path to the user authentication private key (PEM format). NOTE: It is the responsibility of the Ansible administrator to make sure that the private key is stored in a safe location and can only be read by ansible.
    * spp_tls_cert (optional) - The full path to the TLS public certificate that is associated with the SPP appliance. If this certificate path is not provided, the lookup plugin will disable TLS validation which may produce a warning.

## Examples

Inventory file:
```yaml
linuxservers:
  vars:
    ansible_python_interpreter: /usr/bin/python3
    a2aconnectioninfo:
      spp_appliance: 192.168.1.234
      spp_certificate_file: /etc/ansible/spp/a2ausercert.pem
      spp_certificate_key: /etc/ansible/spp/a2ausercert.key
      spp_tls_cert: /etc/ansible/spp/spptlscert.pem

  hosts:
    vm01:
      spp_credential_1: safyBECB8SW5g0Udk7GRFh6LaQ/KoI0eNOW4JK8Cqeo=
      ansible_host: 192.168.2.34
      ansible_user: serviceadmin1
      ansible_password: "{{lookup('safeguardcredentials', spp_credential_1, a2aconnection=a2aconnectioninfo)}}"
    vm02:
      spp_credential_2: ekmiCM/HcEOyIuBfOg2rLwtcH9qcykO9T+He0ySGbKY=
      ansible_host: 192.168.2.35
      ansible_user: serviceadmin2
      ansible_password: "{{lookup('safeguardcredentials', spp_credential_2, a2aconnection=a2aconnectioninfo)}}"
```

Variable file:
```yaml
ansible_python_interpreter: /usr/bin/python3
a2aconnectioninfo:
    spp_appliance: 192.168.1.234
    spp_certificate_file: /etc/ansible/spp/a2ausercert.pem
    spp_certificate_key: /etc/ansible/spp/a2ausercert.key
    spp_tls_cert: /etc/ansible/spp/spptlscert.pem
spp_credential: "{{lookup('safeguardcredentials', spp_credential_apikey, a2aconnection=a2aconnectioninfo)}}"
```

Playbook file:
```yaml
- name: SPP Test Playbook
  hosts: all
  vars:
    spp_credential_apikey: +IWSU/0msm98hUUUen5xOnYZZytVN2o9hLFxVr9S80Q=
    a2aconnectioninfo:
      spp_appliance: 192.168.1.234
      spp_certificate_file: /etc/ansible/spp/a2ausercert.pem
      spp_certificate_key: /etc/ansible/spp/a2ausercert.key
      spp_tls_cert: /etc/ansible/spp/spptlscert.pem
  tasks:
    - name: Get the SPP credential
      set_fact:
        my_credential: "{{lookup('safeguardcredentials', spp_credential_apikey, a2aconnection=a2aconnectioninfo)}}"
```